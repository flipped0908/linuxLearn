# 内核态的内存映射机制，
主要包含以下几个部分: 

内核态内存映射函数vmalloc、kmap_atomic是如何工作的; 

内核态⻚表是放在哪里的，如何工作的?swapper_pg_dir是怎么回事; 

出现了内核态缺⻚异常应该怎么办?

# 内核⻚表
和用户态⻚表不同，在系统初始化的时候，我们就要创建内核⻚表了。

我们从内核⻚表的根swapper_pg_dir开始找线索，在arch/x86/include/asm/pgtable_64.h中就能找到它的定义。
 
 
 内核⻚表的顶级目录init_top_pgt
 
 
## vmalloc和kmap_atomic原理 
 在用户态可以通过malloc函数分配内存，当然malloc在分配比较大的内存的时候，底层调用的是mmap，当然也可以直接通过
 mmap做内存映射，在内核里面也有相应的函数。
 
 
 ## 内核态缺⻚异常
 可以看出，kmap_atomic和vmalloc不同。kmap_atomic发现，没有⻚表的时候，就直接创建⻚表进行映射了。而vmalloc没 有，它只分配了内核的虚拟地址。所以，访问它的时候，会产生缺⻚异常。
 内核态的缺⻚异常还是会调用do_page_fault，但是会走到咱们上面用户态缺⻚异常中没有解析的那部分vmalloc_fault。这个 函数并不复杂，主要用于关联内核⻚表项。
 
 
 ## 总结
 
 物理内存根据NUMA架构分节点。每个节点里面再分区域。每个区域里面再分⻚。
 
 物理⻚面通过伙伴系统进行分配。分配的物理⻚面要变成虚拟地址让上层可以访问，kswapd可以根据物理⻚面的使用情况对⻚面进行换入换出。
 
 对于内存的分配需求，可能来自内核态，也可能来自用户态。
 
 对于内核态，kmalloc在分配大内存的时候，以及vmalloc分配不连续物理⻚的时候，直接使用伙伴系统，分配后转换为虚拟地址，访问的时候需要通过内核⻚表进行映射。
 
 对于kmem_cache以及kmalloc分配小内存，则使用slub分配器，将伙伴系统分配出来的大块内存切成一小块一小块进行分配
 
 kmem_cache和kmalloc的部分不会被换出，因为用这两个函数分配的内存多用于保持内核关键的数据结构。内核态中vmalloc分配的部分会被换出，因而当访问的时候，发现不在，就会调用do_page_fault。
 
 对于用户态的内存分配，或者直接调用mmap系统调用分配，或者调用malloc。调用malloc的时候，如果分配小的内存，就用sys_brk系统调用;如果分配大的内存，还是用sys_mmap系统调用。正常情况下，用户态的内存都是可以换出的，
 因而一旦发现内存中不存在，就会调用do_page_fault。
 
 
 
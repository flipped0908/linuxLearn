# 内核模块
上一节，我们讲过，设备驱动程序是一个内核模块，以ko的文件形式存在，可以通过insmod加载到内核中。  

### 第一部分，头文件部分。

### 第二部分，定义一些函数，用于处理内核模块的主要逻辑。

### 第三部分，定义一个file_operations结构

### 第四部分，定义整个模块的初始化函数和退出函数，

### 第五部分，调用module_init和module_exit

### 第六部分，声明一下lisense，调用MODULE_LICENSE。


# 打开字符设备

字符设备这 个内核模块做了哪些特殊的事情。


要使用一个字符设备，我们首先要把写好的内核模块，通过insmod加载进内核

在字符设备驱动的内核模块加载的时候，最重要的一件事情就是，注册这个字符设备

内核模块加载完毕后，接下来要通过mknod在/dev下面创建一个设备文件



# 写入字符设备

写入一个字符设备，就是用文件系统的标准接口write，参数文件描述符fd，在内核里面调用的sys_write



# 使用IOCTL控制设备 
对于I/O设备来讲，我们前面也说过，除了读写设备，还会调用ioctl，做一些特殊的I/O操作。




# 总结

这一节我们讲了字符设备的打开、写入和ioctl等最常⻅的操作。一个字符设备要能够工作，需要三部分配合。


第一，有一个设备驱动程序的ko模块，里面有模块初始化函数、中断处理函数、设备操作函数。

第二，在/dev目录下有一个文件表示这个设备，这个文件在特殊的devtmpfs文件系统上，因而也有相应的dentry和inode。

第三，打开一个字符设备文件和打开一个普通的文件有类似的数据结构





# 如果一个设 备有事情需要通知操作系统，会通过中断和设备驱动程序进行交互

1 要处理中断，需要有一个中断处理函数。

2 有了中断处理函数，接下来要调用request_irq来注册这个中断处理函数

3 作为内核，我们不可能写程序的时候，适配各种各样的硬件中断控制器，因而就需要有一层中断抽象层。这里虚拟中断信号到 中断描述结构的映射，就是抽象中断层的主要逻辑。



# 总结
我们讲了中断的整个处理过程。中断是从外部设备发起的，会形成外部中断。外部中断会到达中断控制器，中断控制 器会发送中断向量Interrupt Vector给CPU。


对于每一个CPU，都要求有一个idt_table，里面存放了不同的中断向量的处理函数。中断向量表中已经填好了前32位，外加一 位32位系统调用，其他的都是用于设备中断。













































